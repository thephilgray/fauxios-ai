---
import { Resource } from "sst";
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import ArticleContent from '../../components/ArticleContent.astro';
import ResponsiveImage from "../../components/ResponsiveImage.astro";

interface Article {
  articleId: string;
  title: string; // Added title
  headline: string;
  authorName: string; // Added authorName
  createdAt: string; // Added createdAt
  content: {
    hook: string;
    details: string;
    whyItMatters: string;
  };
  imageUrl?: string; // Added imageUrl (optional as it might not exist for older articles)
  imageVariations?: { [key: string]: string }; // Added imageVariations
  topic?: string;
}

export async function getStaticPaths() {
  const apiUrl = Resource.Api.url;
  const response = await fetch(`${apiUrl}/articles`);
  const articles: Article[] = await response.json(); // Explicitly type articles

  return articles.map((article) => ({
    params: { articleId: article.articleId },
    props: { article },
  }));
}

const { articleId } = Astro.params;
const apiUrl = Resource.Api.url;
const response = await fetch(`${apiUrl}/articles/${articleId}`);
let article: Article = await response.json();
article = {
  ...article,
  topic: article.topic || "News" // Default to "News" if topic is missing
};

const title = `Fauxios: ${article?.title || article?.headline || 'Article'}`;
const description = article?.content?.hook ? article.content.hook.substring(0, 150) + "..." : "No description available.";
const ogImageUrl = (article?.imageVariations?.["social-wide"] ? new URL(article.imageVariations["social-wide"], Astro.url.origin).href : null) ||
                   (article?.imageUrl ? new URL(article.imageUrl, Astro.url.origin).href : null) ||
                   new URL("/images/fauxios-logo.svg", Astro.url.origin).href; // Using fauxios-logo.svg as a more reliable fallback

// Fetch all articles for the sidebar
const allArticlesResponse = await fetch(`${apiUrl}/articles`);
const allArticles: Article[] = allArticlesResponse.ok ? await allArticlesResponse.json() : [];

// Filter out the current article and take the first 3
const relatedArticles = allArticles
  .filter(a => a.articleId !== article.articleId)
  .slice(0, 3);


---

<ArticleLayout title={title} description={description} ogImageUrl={ogImageUrl}>
  <div class="container mx-auto px-4 py-8 max-w-screen-xl">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Main Article Content -->
      <div class="lg:col-span-3 bg-white p-8 shadow-md rounded-lg">
        <div class="text-sm text-gray-500 mb-2">{new Date(article.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} {article.topic && `- `}<a href={`/topics/${article.topic.toLowerCase()}`} class="text-blue-600 hover:underline">{article.topic}</a></div>
        <h1 class="text-4xl font-extrabold leading-tight mb-4">{article.title || article.headline}</h1>
        <div class="text-gray-600 text-sm mb-4">By {article.authorName}</div>

        <!-- Social Share Buttons -->
        <div class="flex space-x-4 mb-6 text-sm">
          <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(Astro.url.href)}`} target="_blank" rel="noopener noreferrer" class="flex items-center space-x-1 text-blue-500 hover:text-blue-700 transition duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.814L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            <span>Tweet</span>
          </a>
          <a href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.href)}`} target="_blank" rel="noopener noreferrer" class="flex items-center space-x-1 text-blue-700 hover:text-blue-900 transition duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.505 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33V22C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd"/></svg>
            <span>Share</span>
          </a>
          <a href={`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(Astro.url.href)}&title=${encodeURIComponent(title)}&summary=${encodeURIComponent(description)}&source=${encodeURIComponent(Astro.url.origin)}`} target="_blank" rel="noopener noreferrer" class="flex items-center space-x-1 text-blue-700 hover:text-blue-900 transition duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            <span>LinkedIn</span>
          </a>
          <a href={`mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(Astro.url.href)}%0A%0A${encodeURIComponent(description)}`} class="flex items-center space-x-1 text-gray-600 hover:text-gray-900 transition duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
            <span>Email</span>
          </a>
        </div>

        {article.imageUrl && (
          <figure class="mb-6 bg-gray-100">
            <ResponsiveImage src={article.imageUrl} alt={article.title || article.headline} class="w-full h-auto object-cover rounded-lg" />
            <figcaption class="text-sm text-gray-500 mt-2">Photo: Fauxios</figcaption>
          </figure>
        )}

        <div class="prose prose-lg max-w-none">
          <ArticleContent 
            hook={article?.content?.hook || ''}
            details={article?.content?.details || ''}
            whyItMatters={article?.content?.whyItMatters || ''}
          />
        </div>
      </div>

      <!-- Article Sidebar -->
      <div class="lg:col-span-1 bg-white p-6 shadow-md rounded-lg border border-gray-200">
        <h3 class="text-xl font-bold text-gray-800 mb-4">More from Fauxios</h3>
        {relatedArticles.length > 0 ? (
          <ul class="space-y-4">
            {relatedArticles.map(relatedArticle => (
              <li><a href={`/articles/${relatedArticle.articleId}`} class="text-blue-600 hover:underline">{relatedArticle.title || relatedArticle.headline}</a></li>
            ))}
          </ul>
        ) : (
          <p class="text-gray-500 text-sm">No related articles found.</p>
        )}

        <!-- Ad Space Placeholder -->
        <div class="mt-8 p-4 bg-gray-100 text-center text-gray-500 border border-gray-200 rounded-md">
          Advertisement
          <div class="w-full h-32 bg-gray-200 flex items-center justify-center mt-2 text-gray-400">
            300x250 Ad
          </div>
        </div>
      </div>
    </div>
  </div>
</ArticleLayout>
